<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Gantt Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f2439 100%);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }
        
        .table-row {
            transition: background-color 0.3s ease;
        }
        
        .table-row:hover {
            background-color: #f8fafc;
        }
        
        .table-row.bg-blue-100 {
            background-color: #dbeafe !important;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .category-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .category-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .filter-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .filter-btn:hover {
            transform: scale(1.02);
        }
        
        .filter-btn.active {
            ring: 2px;
            ring-offset: 2px;
        }
        
        .filter-btn.inactive {
            opacity: 0.5;
        }
        
        .refresh-btn {
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        
        .user-menu:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 px-8 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">{{ title }}</h1>
                {% if description %}
                <p class="text-blue-100 text-sm mt-1 max-w-xl">{{ description }}</p>
                {% endif %}
                {% if error %}
                <p class="text-red-300 text-sm mt-1">{{ error }}</p>
                {% elif tasks %}
                <p class="text-blue-200 text-sm mt-1">
                    <span id="task-count">{{ tasks|length }}</span> tasks â€¢ 
                    <span id="date-range">
                        {{ tasks|map(attribute='start_date')|min }} to {{ tasks|map(attribute='end_date')|max }}
                    </span>
                </p>
                {% else %}
                <p class="text-blue-200 text-sm mt-1">No tasks</p>
                {% endif %}
            </div>
            <div class="flex items-center gap-4">
                {% if not error %}
                <span id="last-updated" class="text-blue-200 text-sm">
                    Last updated: <span id="update-time">just now</span>
                </span>
                <button 
                    id="refresh-btn"
                    onclick="refreshData()"
                    class="refresh-btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium flex items-center gap-2"
                >
                    <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
                {% endif %}
                
                <!-- User Menu -->
                {% if user %}
                <div class="user-menu">
                    <button class="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg transition-colors">
                        {% if user.image %}
                        <img src="{{ user.image }}" alt="{{ user.name }}" class="w-6 h-6 rounded-full">
                        {% else %}
                        <div class="w-6 h-6 rounded-full bg-blue-400 flex items-center justify-center text-xs font-medium">
                            {{ user.name[0]|upper if user.name else '?' }}
                        </div>
                        {% endif %}
                        <span class="text-sm">{{ user.name }}</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div class="user-dropdown min-w-[160px]">
                        <div class="px-4 py-3 border-b border-slate-100">
                            <p class="text-sm font-medium text-slate-800">{{ user.name }}</p>
                            <p class="text-xs text-slate-500">{{ user.team_name }}</p>
                        </div>
                        <a href="/logout" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                            Sign out
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    {% if error %}
    <!-- Error State -->
    <main class="max-w-7xl mx-auto px-8 py-8">
        <div class="card p-8 text-center">
            <div class="text-6xl mb-4">ðŸ“‹</div>
            <h2 class="text-xl font-semibold text-slate-800 mb-2">List ID Required</h2>
            <p class="text-slate-600 mb-6">{{ error }}</p>
            <div class="bg-slate-50 rounded-lg p-4 text-left max-w-md mx-auto">
                <p class="text-sm text-slate-600 mb-2">Example URL:</p>
                <code class="text-sm text-blue-600 break-all">{{ request.host_url }}?list_id=YOUR_LIST_ID</code>
            </div>
        </div>
    </main>
    {% else %}
    <main class="max-w-7xl mx-auto px-8 py-8">
        <!-- Filters -->
        <div class="card p-4 mb-6">
            <div class="flex items-center gap-4 flex-wrap">
                <!-- Past events toggle -->
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="show-past-toggle" class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" onchange="togglePastEvents()" {% if show_past %}checked{% endif %}>
                    <span class="text-sm font-medium text-slate-600">Show completed events</span>
                </label>
                
                {% if categories|length > 1 %}
                <span class="text-slate-300">|</span>
                <span class="text-sm font-medium text-slate-600">Categories:</span>
                <button 
                    onclick="toggleAllCategories()" 
                    class="filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-100 text-slate-700 hover:bg-slate-200"
                    id="all-categories-btn"
                >
                    All
                </button>
                {% for cat, color in category_colors.items() %}
                <button 
                    onclick="toggleCategory('{{ cat }}')" 
                    class="filter-btn category-badge {% if cat in active_categories %}active{% else %}inactive{% endif %}"
                    style="background-color: {{ color }}22; color: {{ color }}; border: 2px solid {{ color }};"
                    data-category="{{ cat }}"
                    id="filter-{{ cat|replace(' ', '-') }}"
                >
                    <span class="category-dot" style="background-color: {{ color }};"></span>
                    {{ cat }}
                </button>
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Chart Card -->
        <div class="card p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Timeline View</h2>
                <div class="text-sm text-slate-500">
                    Hover over bars for details â€¢ Drag to pan â€¢ Scroll to zoom
                </div>
            </div>
            <div id="gantt-chart" class="w-full" style="min-height: 500px;"></div>
        </div>

        <!-- Table Card -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">Task Details</h2>
                <div class="text-sm text-slate-500">
                    Data synced from Slack List
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-200">
                            <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Task Name</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Category</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Start Date</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">End Date</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600">Duration</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-slate-600 min-w-[200px]">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="task-table-body">
                        {% for task in tasks %}
                        {% set today = today_date %}
                        {% set is_past = task.end_date < today %}
                        <tr class="table-row border-b border-slate-100 {% if is_past %}past-event{% endif %} cursor-pointer" 
                            id="task-row-{{ task.id }}"
                            data-task-id="{{ task.id }}"
                            data-task-name="{{ task.name }}"
                            data-category="{{ task.category or 'Uncategorized' }}"
                            data-is-past="{{ 'true' if is_past else 'false' }}"
                            onclick="scrollToChartBar('{{ task.id }}', '{{ task.name }}')"
                            {% if is_past %}style="display: none;"{% endif %}>
                            <td class="py-3 px-4">
                                <span class="font-medium text-slate-800 hover:text-blue-600">{{ task.name }}</span>
                            </td>
                            <td class="py-3 px-4">
                                {% set cat = task.category or 'Uncategorized' %}
                                {% set color = category_colors.get(cat, '#6b7280') %}
                                <span class="category-badge" style="background-color: {{ color }}22; color: {{ color }};">
                                    <span class="category-dot" style="background-color: {{ color }};"></span>
                                    {{ cat }}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-slate-600">
                                {{ task.start_date.strftime('%b %d, %Y') }}
                            </td>
                            <td class="py-3 px-4 text-slate-600">
                                {{ task.end_date.strftime('%b %d, %Y') }}
                            </td>
                            <td class="py-3 px-4 text-slate-600">
                                {{ task.duration_days }} days
                            </td>
                            <td class="py-3 px-4 text-slate-600 text-sm">
                                {% if task.metadata.notes %}
                                {{ task.metadata.notes|truncate(100) }}
                                {% else %}
                                <span class="text-slate-400">â€”</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="py-8 text-center text-slate-500">
                                No tasks found. Add tasks to your Slack List and click "Refresh" to sync.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 p-6 bg-blue-50 rounded-xl border border-blue-100">
            <h3 class="font-semibold text-blue-900 mb-2">How to Update Tasks</h3>
            <p class="text-blue-800 text-sm">
                Edit your tasks in the <strong>Slack List</strong>, then click "Refresh" to sync changes here.
                The chart will automatically update with your latest data.
            </p>
        </div>
    </main>

    <script>
        // Initialize chart with server-rendered data
        const chartData = {{ chart_json|safe }};
        const allTasks = {{ tasks_json|safe }};
        const categoryColors = {{ category_colors_json|safe }};
        const todayStr = '{{ today_date.isoformat() }}';
        const listId = '{{ list_id }}';
        
        // Track active categories and past events visibility (from server state)
        let activeCategories = new Set({{ active_categories_json|safe }});
        let showPastEvents = {{ 'true' if show_past else 'false' }};
        
        Plotly.newPlot('gantt-chart', chartData.data, chartData.layout, {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            displaylogo: false
        });
        
        // Handle click on chart bars to scroll to table row
        document.getElementById('gantt-chart').on('plotly_click', function(data) {
            if (data.points && data.points.length > 0) {
                const point = data.points[0];
                if (point.customdata && point.customdata.task_id) {
                    const taskId = point.customdata.task_id;
                    const row = document.getElementById('task-row-' + taskId);
                    if (row) {
                        // Make sure row is visible (enable past events if needed)
                        if (row.style.display === 'none') {
                            document.getElementById('show-past-toggle').checked = true;
                            togglePastEvents();
                        }
                        // Scroll to row with highlight effect
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.classList.add('bg-blue-100');
                        setTimeout(() => {
                            row.classList.remove('bg-blue-100');
                        }, 2000);
                    }
                }
            }
        });

        // Build URL with current filter state
        function buildFilterUrl() {
            const params = new URLSearchParams();
            params.set('list_id', listId);
            if (showPastEvents) {
                params.set('show_past', 'true');
            }
            if (activeCategories.size < Object.keys(categoryColors).length) {
                params.set('categories', Array.from(activeCategories).join(','));
            }
            return '/?' + params.toString();
        }
        
        // Reload page with new filters
        function applyFilters() {
            window.location.href = buildFilterUrl();
        }

        // Toggle past events visibility
        function togglePastEvents() {
            showPastEvents = document.getElementById('show-past-toggle').checked;
            updateTableVisibility();  // Update table immediately
            applyFilters();  // Reload with new chart
        }

        // Toggle category visibility
        function toggleCategory(category) {
            const btn = document.getElementById('filter-' + category.replace(/ /g, '-'));
            
            if (activeCategories.has(category)) {
                activeCategories.delete(category);
                btn.classList.remove('active');
                btn.classList.add('inactive');
            } else {
                activeCategories.add(category);
                btn.classList.remove('inactive');
                btn.classList.add('active');
            }
            
            updateTableVisibility();  // Update table immediately
            applyFilters();  // Reload with new chart
        }
        
        // Toggle all categories
        function toggleAllCategories() {
            const allActive = activeCategories.size === Object.keys(categoryColors).length;
            
            if (allActive) {
                // Deactivate all
                activeCategories.clear();
            } else {
                // Activate all
                activeCategories = new Set(Object.keys(categoryColors));
            }
            
            // Update button states
            Object.keys(categoryColors).forEach(cat => {
                const btn = document.getElementById('filter-' + cat.replace(/ /g, '-'));
                if (btn) {
                    if (activeCategories.has(cat)) {
                        btn.classList.remove('inactive');
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                        btn.classList.add('inactive');
                    }
                }
            });
            
            updateTableVisibility();  // Update table immediately
            applyFilters();  // Reload with new chart
        }
        
        // Update table visibility based on active categories and past events filter
        function updateTableVisibility() {
            const rows = document.querySelectorAll('#task-table-body tr[data-category]');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const category = row.dataset.category;
                const isPast = row.dataset.isPast === 'true';
                const categoryMatch = activeCategories.has(category);
                const pastMatch = showPastEvents || !isPast;
                
                if (categoryMatch && pastMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('task-count').textContent = visibleCount;
        }
        
        // Initialize table visibility on page load
        updateTableVisibility();

        // Refresh data from Slack List
        async function refreshData() {
            const btn = document.getElementById('refresh-btn');
            const icon = document.getElementById('refresh-icon');
            
            // Show loading state
            btn.disabled = true;
            icon.classList.add('spin');
            
            try {
                const response = await fetch('/api/tasks?list_id=' + encodeURIComponent(listId) + '&refresh=true');
                const data = await response.json();
                
                if (data.success) {
                    // Reload the page to show updated data
                    window.location.reload();
                } else {
                    alert('Error refreshing data: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error connecting to server: ' + error.message);
            } finally {
                btn.disabled = false;
                icon.classList.remove('spin');
            }
        }

        // Update time display
        function updateTimeDisplay() {
            const now = new Date();
            document.getElementById('update-time').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        updateTimeDisplay();
        
        // Scroll to chart bar when clicking table row
        function scrollToChartBar(taskId, taskName) {
            // Scroll chart into view
            const chartDiv = document.getElementById('gantt-chart');
            chartDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Find the trace index for this task and highlight it
            const traces = chartData.data;
            for (let i = 0; i < traces.length; i++) {
                const trace = traces[i];
                if (trace.customdata && trace.customdata[0] && trace.customdata[0].task_id === taskId) {
                    // Temporarily increase line width to highlight
                    Plotly.restyle('gantt-chart', {
                        'line.width': 40
                    }, [i]);
                    
                    // Reset after animation
                    setTimeout(() => {
                        Plotly.restyle('gantt-chart', {
                            'line.width': 28
                        }, [i]);
                    }, 1500);
                    break;
                }
            }
        }
    </script>
    {% endif %}

    <!-- Footer -->
    <footer class="text-center py-6 text-slate-400 text-sm">
        Powered by SlackGantt â€¢ 
        <a href="https://slack.com" class="text-blue-500 hover:underline">Open Slack</a>
    </footer>
</body>
</html>
